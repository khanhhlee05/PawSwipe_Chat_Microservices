name: Build and Deploy BackendApp to ECS

#Define when will the workflow be triggered
on:
    push:
        paths:
            - 'backend/**'
        branches:
            - cicd-pipeline

#Define environment variables
env:
    ECR_BACKEND_IMAGE: ${{vars.ECR_BACKEND_IMAGE}}
    AWS_DEFAULT_REGION: ${{vars.AWS_DEFAULT_REGION}}
    ECS_CLUSTER: ${{vars.ECS_CLUSTER}}
    ECS_BACKEND_SERVICE: ${{vars.ECS_BACKEND_SERVICE}}

#Define jobs
jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v2

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v2
              with:
                aws-access-key-id: ${{secrets.AWS_ACCESS_KEY_ID}} #have to create a user on IAM
                aws-secret-access-key: ${{secrets.AWS_SECRET_ACCESS_KEY}}
                aws-region: us-east-1
            

            - name: Login to Amazon ECR
              run: |
                aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin ${{secrets.AWS_ACCOUNT_ID}}.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com

            - name: Build and Push Docker Image
              run: |
                cd backend
                docker buildx create --use
                docker buildx inspect --bootstrap
                docker buildx build --platform linux/amd64 -t ${{secrets.AWS_ACCOUNT_ID}}.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$ECR_BACKEND_IMAGE:latest --push .

            - name: Deploy to ECS
              uses: imehedi/actions-awscli-v2@latest
              with:
                args: ecs update-service --cluster pawswipe-chat-cluster --service PawSwipe-ChatApp-Microservices-Backend --force-new-deployment
              env:
                AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY_ID}}
                AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}
                AWS_DEFAULT_REGION: us-east-1

